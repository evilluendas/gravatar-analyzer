let profileData=null,fetchStats={startTime:null,endTime:null,profilesChecked:0,apiCalls:0};function toggleDropdown(){document.getElementById("downloadDropdown").classList.toggle("show")}async function fetchProfiles(){const e=document.getElementById("usernames").value.split("\n").map((e=>e.trim())).filter((e=>e.length>0));if(0===e.length)return void alert("Please enter at least one username");const t=document.getElementById("result"),n=document.getElementById("stats");t.textContent=`Fetching profiles... (0 of ${e.length})`,document.getElementById("downloadBtn").style.display="none",n.textContent="",fetchStats={startTime:new Date,endTime:null,profilesChecked:e.length,apiCalls:e.length};try{const o=5,a=[];for(let t=0;t<e.length;t+=o)a.push(e.slice(t,t+o));let s={},l=0;for(const n of a){const o=await fetch("fetch_profiles.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({usernames:n})}),a=await o.json();s={...s,...a},l+=n.length,t.textContent=`Fetching profiles... (${l} of ${e.length})`}profileData=s,fetchStats.endTime=new Date,t.textContent=JSON.stringify(profileData,null,2),document.getElementById("downloadBtn").style.display="inline-block";const r=(fetchStats.endTime-fetchStats.startTime)/1e3;n.textContent=`${fetchStats.profilesChecked} profiles checked • ${fetchStats.apiCalls} API calls • ${r.toFixed(1)} seconds`}catch(e){t.textContent="Error fetching profiles: "+e.message,n.textContent=""}}function formatDate(e){if(!e)return"";const t=new Date(e);return`${t.getFullYear()}/${String(t.getMonth()+1).padStart(2,"0")}/${String(t.getDate()).padStart(2,"0")} - ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`}function hasNonEmptyValues(e){return!!e&&(Array.isArray(e)?e.some((e=>hasNonEmptyValues(e))):"object"!=typeof e||Object.values(e).some((e=>null!=e&&""!==e&&!1!==e&&("object"!=typeof e||hasNonEmptyValues(e)))))}function downloadAsCsv(e=!0){if(!profileData)return;const t=Object.entries(profileData).map((([e,t])=>{const n=`https://gravatar.com/${e}`;if(!!t.error)return[e,n,"","No","","","","","","","","","","","","",""];const o=t.profile_url&&!t.profile_url.includes("gravatar.com")?t.profile_url:"No";let a="No";return t.description?a="Yes":(t.location||t.job_title||t.company||t.pronunciation||t.pronouns)&&(a="Partially"),[e,n,t.display_name||"","Yes",t.display_name&&t.display_name!==e?"Yes":"No",a,t.verified_accounts&&t.verified_accounts.length>0?"Yes":"No",t.links&&t.links.length>0?"Yes":"No",t.background_color?"Yes":"No",t.header_image?"Yes":"No",t.gallery&&t.gallery.length>0?"Yes":"No",hasNonEmptyValues(t.interests)?"Yes":"No",hasNonEmptyValues(t.contact_info)?"Yes":"No",hasNonEmptyValues(t.payments)?"Yes":"No",o,formatDate(t.last_profile_edit),formatDate(t.registration_date)]})),n=[...e?[["Gravatar username","Profile URL","Display name","It's public","Custom name","About","Verified accounts","Links","Custom design","Header image","Photos","Interests","Contact info","Send money","Custom domain","Last edit","Registration date"].join(",")]:[],...t.map((e=>e.map((e=>`"${e}"`)).join(",")))].join("\n"),o=(new Date).toISOString().replace(/[:.]/g,"-").replace("T","_").replace("Z",""),a=e?"-with-headers":"",s=new Blob([n],{type:"text/csv;charset=utf-8;"}),l=document.createElement("a"),r=URL.createObjectURL(s);l.setAttribute("href",r),l.setAttribute("download",`gravatar_profiles_${o}${a}.csv`),l.style.visibility="hidden",document.body.appendChild(l),l.click(),document.body.removeChild(l),document.getElementById("downloadDropdown").classList.remove("show")}window.onclick=function(e){if(!e.target.matches("#downloadBtn")){const e=document.getElementsByClassName("dropdown-content");for(let t of e)t.classList.contains("show")&&t.classList.remove("show")}},document.getElementById("usernames").addEventListener("keydown",(function(e){"Enter"===e.key&&(e.metaKey||e.ctrlKey)&&(e.preventDefault(),fetchProfiles())}));